!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Awh={})}(this,(function(e){"use strict";function t(e){return new Promise((t=>{setTimeout(t,e)}))}function r(e){if(""===e||null==e||"number"==typeof e&&isNaN(e))return!0;if("object"==typeof e){if(Array.isArray(e))return 0===e.length;if(e instanceof Map)return 0===e.size;if(e instanceof Set)return 0===e.size;if(e instanceof WeakMap)return!1;if(e instanceof WeakSet)return!1;if(0===Object.keys(e).length)return!0}return!1}function a(e,t){function r(e,t=2){return"string"!=typeof e&&(e=String(e)),e.padStart(t,"0")}e||(e=new Date);var a=r(e.getFullYear(),4),o=r(e.getMonth()+1),n=r(e.getDate()),i=r(e.getHours()),s=r(e.getMinutes()),c=r(e.getSeconds()),u=[{key:"YYYY",value:a},{key:"MM",value:o},{key:"DD",value:n},{key:"HH",value:i},{key:"mm",value:s},{key:"sss",value:r(e.getMilliseconds(),3)},{key:"ss",value:c}];for(var l of u)t=t.replace(l.key,l.value);return t}function o(e,t=2){const r=Math.pow(10,t);return Math.round(e*r)/r}function n(e,t=!1){if(!e)return;let r="string";switch(i(e)){case"text":case"textarea":case"radio":case"select":case"cascadeSelect":case"digitalSignature":r="string";break;case"number":case"rate":case"date":r="number";break;case"cascadeDate":case"address":r="object";break;case"checkbox":case"multiSelect":case"countrySelect":case"image":case"attachment":case"departmentSelect":case"associationForm":r="array";break;case"employee":r=t?"array":"object"}return r}function i(e){if(!e)return;const[t]=e.split("_");return t.replace("Field","")}function s(e,t,a){let o=!1;if(r(t)&&r(a))return!0;if(!r(t)&&r(a)||!r(a)&&r(t))return!1;switch(e){case"countrySelect":case"employee":case"departmentSelect":o=t.value===a.value;break;case"image":case"attachment":o=t.url===a.url;break;case"associationForm":o=t.instanceId===a.instanceId;break;case"cascadeDate":o=t.start===a.start&&t.end===a.end;break;case"address":{const e=t.regionIds,r=a.regionIds,n=e.every(((e,t)=>e===r[t]));o=t.address===a.address&&n;break}default:o=t===a}return o}function c(e,t,r){const a={new:t,old:r};if("array"===n(e)||"employee"===e){let o=t||[],n=r||[];Array.isArray(o)||(o=[o]),Array.isArray(n)||(n=[n]);const i=o.reduce(((t,r)=>n.find((t=>s(e,t,r)))?t:[...t,r]),[]),c=n.reduce(((t,r)=>n.find((t=>s(e,t,r)))?t:[...t,r]),[]);a.isEqual=0===i.length&&0===c.length,a.diff={added:i,removed:c}}else a.isEqual=s(e,t,r);return a}async function u(e,t,r,a,o,n){if(!e)throw Error("context is required");if(!t)throw Error("formUuid is required");if(!r)throw Error("form instance id is required");if(!a)throw Error("table field id is required");o=o||1,n=n||10;const i=await e.dataSourceMap.fetchSubformDatas.load({formUuid:t,formInstanceId:r,tableFieldId:a,currentPage:o,pageSize:n}),{totalCount:s,data:c}=i;return{totalCount:s,subformDatas:c||[],currentPage:o}}function l(e,t,r){if(!e)throw Error("context is required");if(t||(t="form"),!r)throw Error("formInstId is required");let a;if("form"===t?a=e.dataSourceMap.getFormData.load({formInstId:r}).then((e=>e.formData)):"process"===t&&(a=e.dataSourceMap.getProcessInstance.load({processInstanceId:r}).then((e=>e.data))),!a)throw Error(`Unknown type：${t}`);return a}async function f(e,t,r,a,o,n,i){if(!e)throw Error("context is required");if(!r)throw Error("formUuid is required");t||(t="form");const s=JSON.stringify(a||{});let c;if(i&&i.dynamicOrder&&(i.dynamicOrder=JSON.stringify(i.dynamicOrder||{})),"form"===t)c=e.dataSourceMap.searchFormDataIds.load({formUuid:r,searchFieldJson:s,currentPage:o,pageSize:n,...i});else{if("process"!==t)throw Error("Unknow form type: ",t);c=e.dataSourceMap.getInstanceIds.load({formUuid:r,searchFieldJson:s,currentPage:o,pageSize:n,...i})}const u=await c,{currentPage:l,totalCount:f,data:d}=u;return{currentPage:l,totalCount:f,ids:d}}async function d(e,t,r,a,o,n,s){if(!e)throw Error("context is required");if(!r)throw Error("formUuid is required");t||(t="form"),s=Object.assign({strictQuery:!1},s);const c=JSON.stringify(a||{});let u;if(s&&s.dynamicOrder&&(s.dynamicOrder=JSON.stringify(s.dynamicOrder||{})),"form"===t)u=e.dataSourceMap.searchFormDatas.load({formUuid:r,searchFieldJson:c,currentPage:o,pageSize:n,...s});else{if("process"!==t)throw Error("Unknow form type: ",t);u=e.dataSourceMap.getInstances.load({formUuid:r,searchFieldJson:c,currentPage:o,pageSize:n,...s})}const l=await u,{currentPage:f,totalCount:d,data:m}=l;let p=[];"form"===t?p=(m||[]).map((e=>({title:e.title,formUuid:e.formUuid,instanceId:e.formInstId,creator:e.creator,originator:e.originator,originatorCorpId:e.originatorCorpId,originatorCorpName:e.originatorCorpName,gmtCreate:e.gmtCreate,modifier:e.modifier,modifyUser:e.modifyUser,gmtModified:e.gmtModified,...e.formData}))):"process"===t&&(p=(m||[]).map((e=>({title:e.title,formUuid:e.formUuid,instanceId:e.processInstanceId,processCode:e.processCode,instanceStatus:e.instanceStatus,approvedResult:e.approvedResult,originator:e.originator,originatorCorpId:e.originatorCorpId,originatorCorpName:e.originatorCorpName,gmtCreate:e.gmtCreate,gmtModified:e.gmtModified,...e.data}))));const g=p.length;if(s.strictQuery){const e=new Map;for(const t in a){const r=i(t);"text"!==r&&"textarea"!==r||e.set(t,a[t])}p=p.filter((t=>{for(const[r,a]of e)if(t[r]!==a)return!1;return!0}))}return{currentPage:f,actualPageSize:g,totalCount:d,formDatas:p}}async function m(e,t,r,a,o){t||(t="form");let n=[],i=1;for(;;){const{formDatas:s,actualPageSize:c}=await d(e,t,r,a,i,100,o);if(n=n.concat(s),100!==c)break;i+=1}return n}var p=Object.freeze({__proto__:null,default:class{constructor(e,t){"function"!=typeof e?(console.warn("FieldChangeLogger: 您需要提供一个函数用于获取字段初始值，否则将使用一个总是返回undefined的默认函数作为替代"),this.getOldValue=()=>{}):this.getOldValue=e,this.logFormatter="function"!=typeof t?(e,t,r)=>`${t}(${e})发生变更：${JSON.stringify(r)}`:t,this.logMap=new Map}change(e,t,r,a){const o=this.getOldValue(e),n=c(i(e),r,o);n.isEqual?this.logMap.delete(e):this.logMap.set(e,{fieldId:e,fieldName:t,diffResult:n}),"function"==typeof a&&a()}format(e="\n"){return Array.from(this.logMap.values()).map((e=>{const{fieldId:t,fieldName:r,diffResult:a}=e;return this.logFormatter(t,r,a)})).join(e)}clear(){this.logMap.clear()}}});class g{constructor(e,t){this.tableFieldId=t,this.instance=e.$(t),this.instance||this.noInstanceError()}noInstanceError(){throw Error(`无法获取到唯一标识为${this.tableFieldId}的子表单，请检查标识是否正确`)}getInstance(){return this.instance}getDatas(){return this.instance.getValue()}setDatas(e,t){this.instance.setValue(e,t)}getItems(){return this.instance.getItems()}getIndex(e){return(this.getItems()||[]).findIndex((t=>t===e))}getFormGroupId(e){return(this.getItems()||[])[e]}updateItem(e,t){"number"==typeof e&&(e=this.getFormGroupId(e)),this.instance.updateItemValue(e,t)}summary(e,t,r){t=t||"string",r=Object.assign({ignoreEmpty:!0,ignoreDuplicate:!0,filter:()=>!0},r);const a=this.getDatas();let o=[];for(const n of a){const a=n[e];if(r.filter&&r.filter instanceof Function){if(!r.filter(n))continue}if(!r.ignoreEmpty||null!=a)switch(t){case"number":{let e=Number(a);isNaN(e)&&(e=0),o.push(e);break}case"string":if(r.ignoreEmpty&&""===a)break;if(r.ignoreDuplicate&&o.some((e=>e===a)))break;o.push(a);break;case"employee":if(Array.isArray(a))for(const e of a){const t=e.value||e.key;t&&(r.ignoreDuplicate&&o.some((e=>(e.value||e.key)===t))||o.push(e))}else{const e=a.value||a.key;if(r.ignoreDuplicate&&o.some((t=>(t.value||t.key)===e)))break;o.push(a)}break;case"dpt":for(const e of a)r.ignoreDuplicate&&o.some((t=>t.value===e.value))||o.push(e)}}return o}}function h(e,t,r,a,o){const n={[o]:a.instanceId};for(const o of t){const{from:t,to:i,type:s,multiSelect:c,handler:u}=o,l=e[`${t}_id`],f=e[t];if(u&&u instanceof Function)n[i]=u(e,r,a);else switch(s){case"employee":{const e=l.map(((e,t)=>{const r=f[t];return{displayName:r,name:r,label:r,value:e,emplId:e,workId:e,workNo:e}}));n[i]=c?e:e[0];break}case"dpt":n[i]=l.map(((e,t)=>({value:e,name:f[t]})));break;default:n[i]=e[t]}}return n}function y(e,t,r,a){const o={};if(!Array.isArray(t))return o;r&&void 0===a&&console.warn("[resolveConditionMap]: 传入了子表唯一标识时必须传入子表行下标");let n={};t.some((e=>e.isSubform))&&(n=e.$(r).getValue()[a]);for(const r of t){let t;if(t=r.isSubform?n[r.from]:e.$(r.from).getValue(),r.from.startsWith("departmentSelectField")){t=((t||[])[0]||{}).value}if(r.from.startsWith("employeeField")){t=((t||[])[0]||{}).key}o[r.to]=t}return o}e.FieldChangeLogger=p,e.Subform=g,e.activateTabItems=function(e,t){const r=e.$(t);(r.indexesCache||[]).reverse().forEach((e=>{r.onTabChange(e)}))},e.associateForm2Subform=async function(e,t,r,a,o,n,i,s,c){if(t=t||"form",c=Object.assign({keepOldData:!0},c),i&&!s)throw new Error("remoteSubformId is reqired while isDataFromSubform is set to true");const u=e.$(r).getValue()||[],f=e.$(a).getValue(),d=[];for(const e of u){const t=e.instanceId;f.some((e=>e[o]===t))||d.push(e)}console.log(`%c[关联表单填充子表]需要从${d.length}个关联表单新增数据`,"color: purple");let m=[],p=0;for(const e of f){const t=e[o];c.keepOldData&&!t||u.some((e=>e.instanceId===t))?m.push(e):p+=1}console.log(`%c[关联表单填充子表]移除${p}条子表数据`,"color: purple");for(const r of d){const a=await l(e,t,r.instanceId);if(i){const e=a[s]||[];for(const t of e){const e=h(t,n,null,r,o);m.push(e)}}else{const e=h(a,n,null,r,o);m.push(e)}}e.$(a).setValue(m),console.log(`%c[关联表单填充子表]新增了${m.length}条子表数据`,"color: purple")},e.dataLinkage=async function(e,t,r,a,o,n,i,s=!0){if(!r||!a||!o)return;let c,u={};Array.isArray(n)&&(u=y(e,n));const l=Object.values(u).some((e=>null==e||""===e));if(!s||!l){let o=await m(e,t,r,u,{strictQuery:!0});if(o.length){c=o[0][a]}}i instanceof Function&&(c=i(e,c)),e.$(o).getProps().onChange({value:c}),console.log(`[子表数据联动]填充字段: ${o} 填充值: ${c} 严格查询: ${s} 查询参数: `,u)},e.dataLinkageSubform=async function(e,t,r,a,o,n,i,s,c,u=!0){if(!(t&&o&&n&&i))return;const l=(e.$(t).getItems()||[]).indexOf(r);let f,d={};Array.isArray(s)&&(d=y(e,s,t,l));const p=Object.values(d).some((e=>null==e||""===e));if(!u||!p){let t=await m(e,a,o,d,{strictQuery:!0});if(t.length){f=t[0][n]}}c instanceof Function&&(f=c(e,f)),e.$(t).updateItemValue(r,{[i]:f}),console.log(`[子表数据联动]子表ID: ${t}, 填充字段: ${i} 填充值: ${f} 严格查询: ${u} 查询参数: `,d)},e.dateTimeFormat=a,e.deleteFormData=async function(e,t){if(!e)throw Error("context is required");if(!t)throw Error("instanceId is required");return await e.dataSourceMap.deleteFormData.load({formInstId:t})},e.dialog=function(e,t,r,a){return new Promise(((o,n)=>{e.utils.dialog({type:t,title:r,content:a,footerActions:["cancel","ok"],onOk:()=>{o()},onCancel:()=>{n()}})}))},e.fetchSubformDatas=u,e.fetchSubformDatasAll=async function(e,t,r,a){if(!e)throw Error("context is required");if(!t)throw Error("formUuid is required");if(!r)throw Error("form instance id is required");if(!a)throw Error("table field id is required");let o=[],n=1;for(;;){const{subformDatas:i}=await u(e,t,r,a,n,50);if(o=o.concat(i),50!==i.length)break;n+=1}return o},e.fieldToString=function(e,t){if(null==e)return"";let r="";switch(t){case"text":case"textarea":case"digitalSignature":case"number":case"rate":case"radio":case"select":case"cascadeSelect":r=String(e);break;case"date":r=a(new Date(e),"YYYY-MM-DD");break;case"checkbox":case"multiSelect":r=`[${e.join(",")}]`;break;case"cascadeDate":{const{start:t,end:o}=e;r=`${t?a(new Date(t),"YYYY-MM-DD"):""}至${t?a(new Date(o),"YYYY-MM-DD"):""}`;break}case"employee":Array.isArray(e)||(e=[e]),r=`[${e.map((e=>e.name)).join(",")}]`;break;case"departmentSelect":case"countrySelect":r=`[${e.map((e=>{const{text:t}=e;return"string"==typeof t?t:t.zh_CN})).join(",")}]`;break;case"associationForm":r=`[${e.map((e=>e.title)).join(",")}]`;break;case"image":case"attachment":r=`[${e.map((e=>e.name)).join(",")}]`;break;case"address":r=`${(e.regionText||[]).map((e=>e.zh_CN)).join("")}${e.address||""}`}return r},e.fieldValueDiff=c,e.fieldValueEqualSingle=s,e.generateAssociationFormFieldData=function(e,t,r,a){return Array.isArray(a)?a.map((a=>({appType:e,formUuid:t,formType:r,instanceId:a.instanceId,title:a.title,subTitle:a.subTitle}))):null},e.generateDptFieldData=function(e,t){let r=e,a=t;return"string"==typeof e&&(r=[e],a=[t]),Array.isArray(r)?r.map(((e,t)=>({text:a[t],value:e}))):null},e.generateEmployeeFieldData=function(e,t,r=!0){let a=e,o=t;if("string"==typeof e&&(a=[e],o=[t]),!Array.isArray(a))return null;if(r)return a.map(((e,t)=>{const r=o[t];return{displayName:r,name:r,label:r,value:e,emplId:e,workId:e,workNo:e}}));{if(0===a.length)return null;const e=a[0],t=o[0];return{displayName:t,name:t,label:t,value:e,emplId:e,workId:e,workNo:e}}},e.generateRandomId=function(e=32){let t="";for(let r=0;r<e;r++)t+="1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(35*Math.random())];return t},e.getFieldDataTypeById=n,e.getFieldTypeById=i,e.getFormData=l,e.hijackSubmit=function(e){const t=document.querySelector(".deep-form-submit");if(!t)return;const r=t.parentElement;r.style.position="relative";const a=t.getBoundingClientRect(),o=document.createElement("div");o.style.position="absolute",o.style.top=t.offsetTop+"px",o.style.left=t.offsetLeft+"px",o.style.display="inline-block",o.style.width=a.width+"px",o.style.height=a.height+"px",o.onclick=()=>{try{e.beforeBeforeSubmit,t.click()}catch(e){console.log(e.message)}},r.appendChild(o)},e.isEmpty=r,e.loading=function(e,t,r,a=!1){return e.utils.toast({type:"loading",title:t,size:r,hasMask:a})},e.mergeTo=function(){let{from:e,to:t,fieldType:r}=this.params;if(!e||!t)return;Array.isArray(e)||(e=[e]);const a=[];for(const t of e){const e=this.$(t).getValue();void 0!==e&&a.push(e)}let o;if("attachment"===r)o=a.reduce(((e,t)=>e.concat(t)),[]);this.$(t).setValue(o)},e.retry=async function(e,r=3,a=300,...o){let n,i,s=0;for(;s<=r;){s>0&&await t(a);try{return n=e(...o),n instanceof Promise&&await n,n}catch(e){s+=1,i=e}}let c=`All ${r} retries failed.`;throw i&&(c+=`Error: ${i.message}`),Error(c)},e.round=o,e.saveFormData=async function(e,t,r){if(!e)throw Error("context is required");if(!t)throw Error("formUuid is required");r||(r={});const a=JSON.stringify(r);return await e.dataSourceMap.saveFormData.load({formUuid:t,formDataJson:a})},e.searchFormDataIds=f,e.searchFormDataIdsAll=async function(e,t,r,a,o){t||(t="form");let n=[],i=1;for(;;){const{ids:s}=await f(e,t,r,a,i,100,o);if(n=n.concat(s),100!==s.length)break;i+=1}return n},e.searchFormDatas=d,e.searchFormDatasAll=m,e.sleep=t,e.startInstance=async function(e,t,r,a,o){if(!e)throw Error("context is required");if(!t)throw Error("processCode is required");if(!r)throw Error("formUuid is required");a||(a={});const n=JSON.stringify(a);return await e.dataSourceMap.startInstance.load({processCode:t,formUuid:r,formDataJson:n,dptId:o})},e.sum2Main=function(e,t,r,a,n,i){n=n||"string",i=Object.assign({ignoreEmpty:!0,ignoreDuplicate:!0,appendMode:!1,filter:()=>!0,separator:","},i);let s=new g(e,t).summary(r,n,{ignoreEmpty:i.ignoreEmpty,ignoreDuplicate:i.ignoreDuplicate,filter:i.filter});if(i.appendMode){const t=e.$(a).getValue();switch(n){case"string":(t||"").split(",").forEach((e=>{i.ignoreDuplicate&&-1!==s.indexOf(e)||s.unshift(e)}));break;case"number":{let e=Number(t);isNaN(e)&&(e=0),s.unshift(e);break}case"employee":(t||[]).forEach((e=>{const t=e.value||e.key;t&&(i.ignoreDuplicate&&s.some((e=>(e.value||e.key)===t))||s.unshift(e))}));break;case"dpt":(t||[]).forEach((e=>{i.ignoreDuplicate&&s.some((t=>t.value===e.value))||s.unshift(e)}));break}}"string"===n?s=s.join(i.separator):"number"===n&&(s=s.reduce(((e,t)=>e+t),0),"number"==typeof i.decimalPlaces&&(s=o(s,i.decimalPlaces))),e.$(a).setValue(s)},e.syncTo=function(e){const t=e.value;let{target:r}=this.params;r&&(Array.isArray(r)||(r=[r]),r.forEach((e=>{this.$(e).setValue(t)})))},e.updateFormData=async function(e,t,r,a,o=!1){if(!e)throw Error("context is required");if(!r)throw Error("instanceId is required");t||(t="form"),a||(a={});const n=JSON.stringify(a);let i;i="form"===t?e.dataSourceMap.updateFormData.load({formInstId:r,updateFormDataJson:n,useLatestVersion:o}):e.dataSourceMap.updateInstance.load({processInstanceId:r,updateFormDataJson:n}),await i}}));
