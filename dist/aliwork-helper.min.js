!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Awh={})}(this,(function(e){"use strict";async function t(e,t,r,a,n,o){if(!e)throw Error("context is required");if(!t)throw Error("formUuid is required");if(!r)throw Error("form instance id is required");if(!a)throw Error("table field id is required");n=n||1,o=o||10;const i=await e.dataSourceMap.fetchSubformDatas.load({formUuid:t,formInstanceId:r,tableFieldId:a,currentPage:n,pageSize:o}),{totalCount:s,data:c}=i;return{totalCount:s,subformDatas:c||[],currentPage:n}}async function r(e,t,r,a,n,o,i){if(!e)throw Error("context is required");if(!r)throw Error("formUuid is required");t||(t="form");const s=JSON.stringify(a||{});let c;if(i&&i.dynamicOrder&&(i.dynamicOrder=JSON.stringify(i.dynamicOrder||{})),"form"===t)c=e.dataSourceMap.searchFormDataIds.load({formUuid:r,searchFieldJson:s,currentPage:n,pageSize:o,...i});else{if("process"!==t)throw Error("Unknow form type: ",t);c=e.dataSourceMap.getInstanceIds.load({formUuid:r,searchFieldJson:s,currentPage:n,pageSize:o,...i})}const u=await c,{currentPage:d,totalCount:l,data:f}=u;return{currentPage:d,totalCount:l,ids:f}}async function a(e,t,r,a,n,o,i){if(!e)throw Error("context is required");if(!r)throw Error("formUuid is required");t||(t="form");const s=JSON.stringify(a||{});let c;if(i&&i.dynamicOrder&&(i.dynamicOrder=JSON.stringify(i.dynamicOrder||{})),"form"===t)c=e.dataSourceMap.searchFormDatas.load({formUuid:r,searchFieldJson:s,currentPage:n,pageSize:o,...i});else{if("process"!==t)throw Error("Unknow form type: ",t);c=e.dataSourceMap.getInstances.load({formUuid:r,searchFieldJson:s,currentPage:n,pageSize:o,...i})}const u=await c,{currentPage:d,totalCount:l,data:f}=u;return{currentPage:d,totalCount:l,formDatas:(f||[]).map((e=>({...e,...e.formData,...e.data})))}}function n(e){return new Promise((t=>{setTimeout(t,e)}))}function o(e){if(""===e||null==e||"number"==typeof e&&isNaN(e))return!0;if("object"==typeof e){if(Array.isArray(e))return 0===e.length;if(e instanceof Map)return 0===e.size;if(e instanceof Set)return 0===e.size;if(e instanceof WeakMap)return!1;if(e instanceof WeakSet)return!1;if(0===Object.keys(e).length)return!0}return!1}function i(e,t){function r(e,t=2){return"string"!=typeof e&&(e=String(e)),e.padStart(t,"0")}e||(e=new Date);var a=r(e.getFullYear(),4),n=r(e.getMonth()+1),o=r(e.getDate()),i=r(e.getHours()),s=r(e.getMinutes()),c=r(e.getSeconds()),u=[{key:"YYYY",value:a},{key:"MM",value:n},{key:"DD",value:o},{key:"HH",value:i},{key:"mm",value:s},{key:"sss",value:r(e.getMilliseconds(),3)},{key:"ss",value:c}];for(var d of u)t=t.replace(d.key,d.value);return t}function s(e,t=!1){if(!e)return;let r="string";switch(c(e)){case"text":case"textarea":case"radio":case"select":case"cascadeSelect":case"digitalSignature":r="string";break;case"number":case"rate":case"date":r="number";break;case"cascadeDate":case"address":r="object";break;case"checkbox":case"multiSelect":case"countrySelect":case"image":case"attachment":case"departmentSelect":case"associationForm":r="array";break;case"employee":r=t?"array":"object"}return r}function c(e){if(!e)return;const[t]=e.split("_");return t.replace("Field","")}function u(e,t,r){let a=!1;if(o(t)&&o(r))return!0;if(!o(t)&&o(r)||!o(r)&&o(t))return!1;switch(e){case"countrySelect":case"employee":case"departmentSelect":a=t.value===r.value;break;case"image":case"attachment":a=t.url===r.url;break;case"associationForm":a=t.instanceId===r.instanceId;break;case"cascadeDate":a=t.start===r.start&&t.end===r.end;break;case"address":{const e=t.regionIds,n=r.regionIds,o=e.every(((e,t)=>e===n[t]));a=t.address===r.address&&o;break}default:a=t===r}return a}e.activateTabItems=function(e,t){const r=e.$(t);(r.indexesCache||[]).reverse().forEach((e=>{r.onTabChange(e)}))},e.dateTimeFormat=i,e.deleteFormData=async function(e,t){if(!e)throw Error("context is required");if(!t)throw Error("instanceId is required");return await e.dataSourceMap.deleteFormData.load({formInstId:t})},e.dialog=function(e,t,r,a){return new Promise(((n,o)=>{e.utils.dialog({type:t,title:r,content:a,footerActions:["cancel","ok"],onOk:()=>{n()},onCancel:()=>{o()}})}))},e.fetchSubformDatas=t,e.fetchSubformDatasAll=async function(e,r,a,n){if(!e)throw Error("context is required");if(!r)throw Error("formUuid is required");if(!a)throw Error("form instance id is required");if(!n)throw Error("table field id is required");let o=[],i=1;for(;;){const{subformDatas:s}=await t(e,r,a,n,i,50);if(o=o.concat(s),50!==s.length)break;i+=1}return o},e.fieldToString=function(e,t){if(null==e)return"";let r="";switch(t){case"text":case"textarea":case"digitalSignature":case"number":case"rate":case"radio":case"select":case"cascadeSelect":r=String(e);break;case"date":r=i(new Date(e),"YYYY-MM-DD");break;case"checkbox":case"multiSelect":r=`[${e.join(",")}]`;break;case"cascadeDate":{const{start:t,end:a}=e;r=`${t?i(new Date(t),"YYYY-MM-DD"):""}至${t?i(new Date(a),"YYYY-MM-DD"):""}`;break}case"employee":Array.isArray(e)||(e=[e]),r=`[${e.map((e=>e.name)).join(",")}]`;break;case"departmentSelect":case"countrySelect":r=`[${e.map((e=>{const{text:t}=e;return"string"==typeof t?t:t.zh_CN})).join(",")}]`;break;case"associationForm":r=`[${e.map((e=>e.title)).join(",")}]`;break;case"image":case"attachment":r=`[${e.map((e=>e.name)).join(",")}]`;break;case"address":r=`${(e.regionText||[]).map((e=>e.zh_CN)).join("")}${e.address||""}`}return r},e.fieldValueDiff=function(e,t,r){const a={new:t,old:r};if("array"===s(e)||"employee"===e){let n=t||[],o=r||[];Array.isArray(n)||(n=[n]),Array.isArray(o)||(o=[o]);const i=n.reduce(((t,r)=>o.find((t=>u(e,t,r)))?t:[...t,r]),[]),s=o.reduce(((t,r)=>o.find((t=>u(e,t,r)))?t:[...t,r]),[]);a.isEqual=0===i.length&&0===s.length,a.diff={added:i,removed:s}}else a.isEqual=u(e,t,r);return a},e.fieldValueEqualSingle=u,e.generateAssociationFormFieldData=function(e,t,r,a){return Array.isArray(a)?a.map((a=>({appType:e,formUuid:t,formType:r,instanceId:a.instanceId,title:a.title,subTitle:a.subTitle}))):null},e.generateDptFieldData=function(e,t){let r=e,a=t;return"string"==typeof e&&(r=[e],a=[t]),Array.isArray(r)?r.map(((e,t)=>({text:a[t],value:e}))):null},e.generateEmployeeFieldData=function(e,t,r=!0){let a=e,n=t;if("string"==typeof e&&(a=[e],n=[t]),!Array.isArray(a))return null;if(r)return a.map(((e,t)=>{const r=n[t];return{displayName:r,name:r,label:r,value:e,emplId:e,workId:e,workNo:e}}));{if(0===a.length)return null;const e=a[0],t=n[0];return{displayName:t,name:t,label:t,value:e,emplId:e,workId:e,workNo:e}}},e.getFieldDataTypeById=s,e.getFieldTypeById=c,e.getFormData=function(e,t,r){if(!e)throw Error("context is required");if(t||(t="form"),!r)throw Error("formInstId is required");let a;if("form"===t?a=e.dataSourceMap.getFormData.load({formInstId:r}).then((e=>e.formData)):"process"===t&&(a=e.dataSourceMap.getProcessInstance.load({processInstanceId:r}).then((e=>e.data))),!a)throw Error(`Unknown type：${t}`);return a},e.hijackSubmit=function(e){const t=document.querySelector(".deep-form-submit");if(!t)return;const r=t.parentElement;r.style.position="relative";const a=t.getBoundingClientRect(),n=document.createElement("div");n.style.position="absolute",n.style.top=t.offsetTop+"px",n.style.left=t.offsetLeft+"px",n.style.display="inline-block",n.style.width=a.width+"px",n.style.height=a.height+"px",n.onclick=()=>{try{e.beforeBeforeSubmit,t.click()}catch(e){console.log(e.message)}},r.appendChild(n)},e.isEmpty=o,e.loading=function(e,t,r,a=!1){return e.utils.toast({type:"loading",title:t,size:r,hasMask:a})},e.mergeTo=function(){let{from:e,to:t,fieldType:r}=this.params;if(!e||!t)return;Array.isArray(e)||(e=[e]);const a=[];for(const t of e){const e=this.$(t).getValue();void 0!==e&&a.push(e)}let n;if("attachment"===r)n=a.reduce(((e,t)=>e.concat(t)),[]);this.$(t).setValue(n)},e.retry=async function(e,t=3,r=300,...a){let o,i,s=0;for(;s<=t;){s>0&&await n(r);try{return o=e(...a),o instanceof Promise&&await o,o}catch(e){s+=1,i=e}}let c=`All ${t} retries failed.`;throw i&&(c+=`Error: ${i.message}`),Error(c)},e.saveFormData=async function(e,t,r){if(!e)throw Error("context is required");if(!t)throw Error("formUuid is required");r||(r={});const a=JSON.stringify(r);return await e.dataSourceMap.saveFormData.load({formUuid:t,formDataJson:a})},e.searchFormDataIds=r,e.searchFormDataIdsAll=async function(e,t,a,n,o){t||(t="form");let i=[],s=1;for(;;){const{ids:c}=await r(e,t,a,n,s,100,o);if(i=i.concat(c),100!==c.length)break;s+=1}return i},e.searchFormDatas=a,e.searchFormDatasAll=async function(e,t,r,n,o){t||(t="form");let i=[],s=1;for(;;){const{formDatas:c}=await a(e,t,r,n,s,100,o);if(i=i.concat(c),100!==c.length)break;s+=1}return i},e.sleep=n,e.syncTo=function(e){const t=e.value;let{target:r}=this.params;r&&(Array.isArray(r)||(r=[r]),r.forEach((e=>{this.$(e).setValue(t)})))},e.updateFormData=async function(e,t,r,a,n=!1){if(!e)throw Error("context is required");if(!r)throw Error("instanceId is required");t||(t="form"),a||(a={});const o=JSON.stringify(a);let i;i="form"===t?e.dataSourceMap.updateFormData.load({formInstId:r,updateFormDataJson:o,useLatestVersion:n}):e.dataSourceMap.updateInstance.load({processInstanceId:r,updateFormDataJson:o}),await i}}));
